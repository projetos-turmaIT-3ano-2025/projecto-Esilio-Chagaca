<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Administrativo - Projeto Multitemático</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="estilo.css">
  <style>
    .dashboard-card {
      transition: all 0.3s ease;
    }
    .dashboard-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .stat-value {
      font-size: 2.5rem;
      font-weight: 700;
      color: #0d6efd;
    }
    .stat-label {
      font-size: 1rem;
      color: #6c757d;
    }
    .admin-level {
      position: absolute;
      top: 0;
      right: 0;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      border-radius: 0 0.25rem 0 0.25rem;
    }
    .admin1 {
      background-color: #dc3545;
      color: white;
    }
    .admin2 {
      background-color: #ffc107;
      color: #212529;
    }
    .table-usuarios th, .table-usuarios td {
      vertical-align: middle;
    }
    .status-indicator {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 5px;
    }
    .status-online {
      background-color: #28a745;
    }
    .status-offline {
      background-color: #dc3545;
    }
  </style>
</head>
<body>
  <!-- Navbar responsiva -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Projeto Multitemático</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="index.html">AJAX</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="chat.html">WebSocket</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="chatbot.html">ChatBot</a>
          </li>
        </ul>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown" id="temas-dropdown" style="display: none;">
            <a class="nav-link dropdown-toggle" href="#" id="temasDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Temas
            </a>
            <ul class="dropdown-menu dropdown-menu-end" id="temas-lista">
              <!-- Temas serão adicionados dinamicamente aqui -->
            </ul>
          </li>
          <li class="nav-item dropdown" id="usuario-dropdown" style="display: none;">
            <a class="nav-link dropdown-toggle" href="#" id="usuarioDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <span id="usuario-nome">Usuário</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item active" href="admin.html">Dashboard Admin</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" id="btn-logout">Sair</a></li>
            </ul>
          </li>
          <li class="nav-item" id="login-item">
            <a class="nav-link" href="login.html?returnUrl=admin.html">Login</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- Alerta para usuários não autorizados -->
    <div class="alert alert-danger" id="nao-autorizado-alert" style="display: none;">
      <i class="fas fa-exclamation-triangle me-2"></i> Você não tem permissão para acessar esta página. Apenas administradores podem visualizar o dashboard.
    </div>

    <!-- Conteúdo da página admin -->
    <div id="admin-content" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="fas fa-tachometer-alt me-2"></i> Dashboard Administrativo</h1>
        <span class="badge bg-primary" id="admin-type">Tipo de Admin</span>
      </div>

      <!-- Indicador de perfil de acesso -->
      <div id="admin2-notice" style="display: none;" class="alert alert-warning mb-4">
        <i class="fas fa-info-circle me-2"></i> Você está logado como <strong>Docente</strong>. Este perfil tem acesso apenas a funcionalidades de monitoramento.
      </div>

      <!-- Estatísticas -->
      <div class="row mb-4" id="estatisticas-container">
        <!-- As estatísticas serão preenchidas via JavaScript -->
      </div>

      <!-- Tabs para diferentes seções -->
      <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="usuarios-tab" data-bs-toggle="tab" data-bs-target="#usuarios" type="button" role="tab" aria-controls="usuarios" aria-selected="true">
            <i class="fas fa-users me-2"></i> Usuários
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="atividades-tab" data-bs-toggle="tab" data-bs-target="#atividades" type="button" role="tab" aria-controls="atividades" aria-selected="false">
            <i class="fas fa-chart-line me-2"></i> Atividades Recentes
          </button>
        </li>
        <li class="nav-item admin1-only" role="presentation" style="display: none;">
          <button class="nav-link" id="configuracoes-tab" data-bs-toggle="tab" data-bs-target="#configuracoes" type="button" role="tab" aria-controls="configuracoes" aria-selected="false">
            <i class="fas fa-cog me-2"></i> Configurações
          </button>
        </li>
      </ul>

      <!-- Conteúdo das abas -->
      <div class="tab-content" id="adminTabsContent">
        <!-- Tab Usuários -->
        <div class="tab-pane fade show active" id="usuarios" role="tabpanel" aria-labelledby="usuarios-tab">
          <div class="card">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="fas fa-users me-2"></i> Lista de Usuários</h5>
              <button class="btn btn-light btn-sm admin1-only" id="btn-atualizar-usuarios" style="display: none;">
                <i class="fas fa-sync-alt me-1"></i> Atualizar
              </button>
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover table-usuarios">
                  <thead>
                    <tr>
                      <th>ID</th>
                      <th>Nome</th>
                      <th>Email</th>
                      <th>Perfil</th>
                      <th>Data de Criação</th>
                      <th>Último Login</th>
                      <th>Tema</th>
                      <th>Perguntas ChatBot</th>
                    </tr>
                  </thead>
                  <tbody id="usuarios-lista">
                    <!-- Lista de usuários será preenchida via JavaScript -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Tab Atividades -->
        <div class="tab-pane fade" id="atividades" role="tabpanel" aria-labelledby="atividades-tab">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i> Atividades Recentes</h5>
            </div>
            <div class="card-body">
              <div id="atividades-container">
                <!-- Atividades serão preenchidas via JavaScript -->
              </div>
            </div>
          </div>
        </div>

        <!-- Tab Configurações (apenas Admin1) -->
        <div class="tab-pane fade" id="configuracoes" role="tabpanel" aria-labelledby="configuracoes-tab">
          <div class="card">
            <div class="card-header bg-primary text-white">
              <h5 class="mb-0"><i class="fas fa-cog me-2"></i> Configurações do Sistema</h5>
            </div>
            <div class="card-body">
              <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i> Esta seção está disponível apenas para Administradores com acesso completo.
              </div>
              <form id="config-form">
                <div class="mb-3">
                  <label for="config-chatbot-limite" class="form-label">Limite de perguntas por usuário no ChatBot</label>
                  <input type="number" class="form-control" id="config-chatbot-limite" value="5" min="1" max="50">
                </div>
                <div class="mb-3">
                  <label for="config-sessao-duracao" class="form-label">Duração da sessão (horas)</label>
                  <input type="number" class="form-control" id="config-sessao-duracao" value="1" min="1" max="24">
                </div>
                <button type="submit" class="btn btn-primary">Salvar Configurações</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de alerta para feedback visual -->
  <div class="modal fade" id="modalAlerta" tabindex="-1" aria-labelledby="modalAlertaLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalAlertaLabel">Atenção</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modalAlertaBody"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Variáveis globais
    let usuarioLogado = null;
    let temaSelecionado = null;
    let tipoAdmin = null;
    let usuariosLista = [];
    let estatisticas = {};
    let intervaloAtualizacao = null;
    
    // Elementos DOM
    const adminContent = document.getElementById('admin-content');
    const naoAutorizadoAlert = document.getElementById('nao-autorizado-alert');
    const adminType = document.getElementById('admin-type');
    const admin2Notice = document.getElementById('admin2-notice');
    const estatisticasContainer = document.getElementById('estatisticas-container');
    const usuariosLista_el = document.getElementById('usuarios-lista');
    const atividadesContainer = document.getElementById('atividades-container');
    const btnAtualizarUsuarios = document.getElementById('btn-atualizar-usuarios');
    const configForm = document.getElementById('config-form');
    const usuarioDropdown = document.getElementById('usuario-dropdown');
    const usuarioNome = document.getElementById('usuario-nome');
    const loginItem = document.getElementById('login-item');
    const btnLogout = document.getElementById('btn-logout');
    const temasDropdown = document.getElementById('temas-dropdown');
    const temasLista = document.getElementById('temas-lista');
    const admin1Elements = document.querySelectorAll('.admin1-only');
    
    // Verifica se o usuário está logado e tem permissão de admin
    async function verificarPermissao() {
      try {
        const response = await fetch('/api/verificar-login');
        if (response.ok) {
          const data = await response.json();
          usuarioLogado = data.usuario;
          temaSelecionado = data.temaSelecionado;
          
          // Atualiza interface para usuário logado
          usuarioNome.textContent = usuarioLogado.nome;
          usuarioDropdown.style.display = 'block';
          loginItem.style.display = 'none';
          
          // Verifica se é um perfil admin
          if (usuarioLogado.perfil === 'admin1' || usuarioLogado.perfil === 'admin2') {
            tipoAdmin = usuarioLogado.perfil;
            adminType.textContent = tipoAdmin === 'admin1' ? 'Administrador Principal' : 'Docente';
            adminType.className = tipoAdmin === 'admin1' ? 'badge bg-danger' : 'badge bg-warning text-dark';
            
            // Mostra o alerta para admin2 (Docente)
            if (tipoAdmin === 'admin2') {
              admin2Notice.style.display = 'block';
            }
            
            // Mostra elementos exclusivos de admin1
            if (tipoAdmin === 'admin1') {
              admin1Elements.forEach(el => el.style.display = 'block');
            }
            
            // Exibe conteúdo admin
            adminContent.style.display = 'block';
            naoAutorizadoAlert.style.display = 'none';
            
            // Carrega dados iniciais
            carregarEstatisticas();
            carregarUsuarios();
            
            // Configura atualização automática
            intervaloAtualizacao = setInterval(carregarEstatisticas, 30000); // A cada 30 segundos
            
            // Carrega temas disponíveis
            carregarTemas();
            
            return true;
          } else {
            // Não é admin
            adminContent.style.display = 'none';
            naoAutorizadoAlert.style.display = 'block';
            return false;
          }
        } else {
          // Não está logado
          window.location.href = 'login.html?returnUrl=admin.html';
          return false;
        }
      } catch (error) {
        console.error('Erro ao verificar permissão:', error);
        exibirAlerta('Erro ao verificar permissão de acesso');
        return false;
      }
    }
    
    // Carrega estatísticas do sistema
    async function carregarEstatisticas() {
      try {
        const response = await fetch('/api/admin/estatisticas');
        if (response.ok) {
          estatisticas = await response.json();
          atualizarEstatisticas();
        } else {
          console.error('Erro ao carregar estatísticas:', await response.text());
        }
      } catch (error) {
        console.error('Erro ao carregar estatísticas:', error);
      }
    }
    
    // Atualiza o painel de estatísticas
    function atualizarEstatisticas() {
      const cardTemplate = (icon, title, value, colorClass) => `
        <div class="col-md-3 col-sm-6 mb-4">
          <div class="card dashboard-card">
            <div class="card-body text-center">
              <i class="fas fa-${icon} fa-3x mb-3 text-${colorClass}"></i>
              <div class="stat-value">${value}</div>
              <div class="stat-label">${title}</div>
            </div>
          </div>
        </div>
      `;
      
      estatisticasContainer.innerHTML = 
        cardTemplate('users', 'Usuários Ativos', estatisticas.usuariosAtivos || 0, 'primary') +
        cardTemplate('sign-in-alt', 'Acessos Totais', estatisticas.acessosTotais || 0, 'success') +
        cardTemplate('comment', 'Mensagens Chat', estatisticas.mensagensChat || 0, 'info') +
        cardTemplate('robot', 'Perguntas ChatBot', estatisticas.perguntasChatbot || 0, 'warning');
    }
    
    // Carrega lista de usuários
    async function carregarUsuarios() {
      try {
        const response = await fetch('/api/admin/usuarios');
        if (response.ok) {
          usuariosLista = await response.json();
          atualizarListaUsuarios();
          gerarAtividadesRecentes();
        } else {
          console.error('Erro ao carregar usuários:', await response.text());
        }
      } catch (error) {
        console.error('Erro ao carregar usuários:', error);
      }
    }
    
    // Atualiza a tabela de usuários
    function atualizarListaUsuarios() {
      usuariosLista_el.innerHTML = '';
      
      usuariosLista.forEach(usuario => {
        const tr = document.createElement('tr');
        
        // Formata datas
        const dataCriacao = new Date(usuario.dataCriacao).toLocaleString();
        const ultimoLogin = new Date(usuario.ultimoLogin).toLocaleString();
        
        // Define classe para destacar admins
        if (usuario.perfil.includes('admin')) {
          tr.classList.add('table-warning');
        }
        
        tr.innerHTML = `
          <td>${usuario.id}</td>
          <td>${usuario.nome}</td>
          <td>${usuario.email}</td>
          <td><span class="badge ${usuario.perfil === 'admin1' ? 'bg-danger' : usuario.perfil === 'admin2' ? 'bg-warning text-dark' : 'bg-secondary'}">${usuario.perfil}</span></td>
          <td>${dataCriacao}</td>
          <td>${ultimoLogin}</td>
          <td><span class="badge bg-info">${usuario.temaSelecionado}</span></td>
          <td>${usuario.perguntasChatBot} / 5</td>
        `;
        
        usuariosLista_el.appendChild(tr);
      });
    }
    
    // Gera a lista de atividades recentes
    function gerarAtividadesRecentes() {
      const atividadesHTML = [];
      
      // Ordena usuários pelo último login (mais recente primeiro)
      const usuariosOrdenados = [...usuariosLista].sort((a, b) => 
        new Date(b.ultimoLogin) - new Date(a.ultimoLogin)
      );
      
      // Gera cards de atividade para os 5 últimos logins
      usuariosOrdenados.slice(0, 5).forEach(usuario => {
        const ultimoLogin = new Date(usuario.ultimoLogin);
        const agora = new Date();
        const diffMs = agora - ultimoLogin;
        const diffHoras = Math.floor(diffMs / (1000 * 60 * 60));
        const tempoDecorrido = diffHoras < 1 
          ? 'Há menos de uma hora' 
          : diffHoras === 1 
            ? 'Há 1 hora' 
            : `Há ${diffHoras} horas`;
        
        atividadesHTML.push(`
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h5 class="card-title mb-1">
                    <i class="fas fa-user-circle me-2"></i> ${usuario.nome}
                    <span class="badge ${usuario.perfil === 'admin1' ? 'bg-danger' : usuario.perfil === 'admin2' ? 'bg-warning text-dark' : 'bg-secondary'} ms-2">${usuario.perfil}</span>
                  </h5>
                  <p class="card-text text-muted mb-0">
                    Último acesso: ${ultimoLogin.toLocaleString()} (${tempoDecorrido})
                  </p>
                </div>
                <span class="badge ${diffHoras < 1 ? 'bg-success' : diffHoras < 12 ? 'bg-info' : 'bg-secondary'}">
                  <i class="fas fa-clock me-1"></i> ${diffHoras < 1 ? 'Online recentemente' : 'Inativo'}
                </span>
              </div>
              <div class="mt-2">
                <small class="text-muted">
                  <i class="fas fa-palette me-1"></i> Tema: ${usuario.temaSelecionado} | 
                  <i class="fas fa-robot me-1"></i> Perguntas ChatBot: ${usuario.perguntasChatBot}/5
                </small>
              </div>
            </div>
          </div>
        `);
      });
      
      atividadesContainer.innerHTML = atividadesHTML.join('') || 
        '<div class="alert alert-info">Nenhuma atividade recente registrada.</div>';
    }
    
    // Função para carregar temas disponíveis
    async function carregarTemas() {
      try {
        const response = await fetch('/api/temas');
        if (response.ok) {
          const temas = await response.json();
          // Preenche dropdown de temas
          temasLista.innerHTML = '';
          temas.forEach(tema => {
            const li = document.createElement('li');
            const a = document.createElement('a');
            a.classList.add('dropdown-item');
            a.setAttribute('data-tema', tema.id);
            a.innerHTML = `<i class="fas fa-${tema.icone || 'palette'}"></i> ${tema.nome}`;
            
            // Marca tema atual
            if (tema.id === temaSelecionado) {
              a.classList.add('active');
            }
            
            // Evento de click para mudar tema
            a.addEventListener('click', () => mudarTema(tema.id));
            
            li.appendChild(a);
            temasLista.appendChild(li);
          });
          
          // Exibe dropdown de temas
          temasDropdown.style.display = 'block';
        }
      } catch (error) {
        console.error('Erro ao carregar temas:', error);
      }
    }
    
    // Função para mudar tema
    async function mudarTema(temaId) {
      try {
        const response = await fetch('/api/tema', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tema: temaId })
        });
        
        if (response.ok) {
          temaSelecionado = temaId;
          location.reload(); // Recarrega para aplicar o tema
        } else {
          exibirAlerta('Erro ao alterar tema');
        }
      } catch (error) {
        exibirAlerta('Erro ao conectar com o servidor');
      }
    }
    
    // Exibe alerta
    function exibirAlerta(mensagem) {
      document.getElementById('modalAlertaBody').innerText = mensagem;
      const modal = new bootstrap.Modal(document.getElementById('modalAlerta'));
      modal.show();
    }
    
    // Evento de logout
    btnLogout.addEventListener('click', async function(e) {
      e.preventDefault();
      
      try {
        const response = await fetch('/api/logout', {
          method: 'POST'
        });
        
        if (response.ok) {
          clearInterval(intervaloAtualizacao);
          window.location.href = 'login.html';
        } else {
          exibirAlerta('Erro ao fazer logout');
        }
      } catch (error) {
        exibirAlerta('Erro ao conectar com o servidor');
      }
    });
    
    // Evento de atualização manual da lista de usuários
    btnAtualizarUsuarios.addEventListener('click', function(e) {
      e.preventDefault();
      carregarUsuarios();
      carregarEstatisticas();
      exibirAlerta('Dados atualizados com sucesso!');
    });
    
    // Evento de submissão do formulário de configurações
    configForm.addEventListener('submit', function(e) {
      e.preventDefault();
      // Esta função seria implementada para salvar configurações no servidor
      // Por simplicidade, apenas mostramos um alerta de sucesso
      exibirAlerta('Configurações salvas com sucesso!');
    });
    
    // Inicializa a página
    window.addEventListener('load', () => {
      verificarPermissao();
    });
  </script>
</body>
</html> 